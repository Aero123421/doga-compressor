name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Generate Release Notes (Bilingual)
        id: release_notes
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Get commits since previous tag or all commits
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%h|%s")
          else
            COMMITS=$(git log --pretty=format:"%h|%s")
          fi
          
          # Generate release notes
          echo "# Release ${{ github.event.inputs.tag }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "> âš ï¸ **Notice**: This project is entirely AI-generated and coded." >> release_notes.md
          echo "" >> release_notes.md
          echo "> âš ï¸ **Unsigned APK Warning**: These APKs are unsigned. You may encounter installation restrictions and will not be able to update without uninstalling the previous version." >> release_notes.md
          echo "" >> release_notes.md
          echo "## English / English" >> release_notes.md
          echo "" >> release_notes.md
          
          # Parse commits and categorize
          FEATURES=$(echo "$COMMITS" | grep -i "^.*|feat:" || echo "")
          FIXES=$(echo "$COMMITS" | grep -i "^.*|fix:" || echo "")
          OTHERS=$(echo "$COMMITS" | grep -v -i "^.*|feat:" | grep -v -i "^.*|fix:" || echo "")
          
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features / æ–°æ©Ÿèƒ½" >> release_notes.md
            echo "$FEATURES" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes / ãƒã‚°ä¿®æ­£" >> release_notes.md
            echo "$FIXES" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$OTHERS" ]; then
            echo "### ðŸ“ Other Changes / ãã®ä»–ã®å¤‰æ›´" >> release_notes.md
            echo "$OTHERS" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## Japanese / æ—¥æœ¬èªž" >> release_notes.md
          echo "" >> release_notes.md
          echo "> âš ï¸ **æ³¨æ„**: ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å®Œå…¨ã«AIã«ã‚ˆã£ã¦ç”Ÿæˆãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "> âš ï¸ **ç½²åãªã—APKã®æ³¨æ„**: ã“ã‚Œã‚‰ã®APKã¯ç½²åã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«åˆ¶é™ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„ã¨æ›´æ–°ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ github.event.inputs.tag }} ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚" >> release_notes.md
          echo "" >> release_notes.md
          
          # Japanese translation
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ æ–°æ©Ÿèƒ½" >> release_notes.md
            echo "$FEATURES" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### ðŸ› ãƒã‚°ä¿®æ­£" >> release_notes.md
            echo "$FIXES" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$OTHERS" ]; then
            echo "### ðŸ“ ãã®ä»–ã®å¤‰æ›´" >> release_notes.md
            echo "$OTHERS" | sed 's/[^|]*|/ - /' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          cat release_notes.md
      
      - name: Tag Release
        run: |
          git tag -a ${{ github.event.inputs.tag }} -m "Release ${{ github.event.inputs.tag }}"
          git push origin ${{ github.event.inputs.tag }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          body_path: release_notes.md
          files: |
            app/build/outputs/apk/release/app-release-unsigned.apk
            app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
